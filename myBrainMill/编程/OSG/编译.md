# 帮助文档网址 
http://docs.osgearth.org/en/latest/build.html

# 版本
https://github.com/gwaldron/osgearth/releases/tag/osgearth-3.3

# 过程
## 1安装visual studio community 2022
要安装英语语言包，据说vcpkg会用到
## 2安装cmake
cmake-3.24.1-windows-x86_64
## 3安装git
https://git-scm.com/download/win
## 4安装powershell7
https://docs.microsoft.com/zh-cn/powershell/scripting/install/installing-powershell-on-windows?view=powershell-7.2
## 5安装VCPKG
 https://github.com/microsoft/vcpkg/releases/tag/2022.08.15
 文档在https://github.com/microsoft/vcpkg/blob/master/README_zh_CN.md
### 5.1运行.\vcpkg\bootstrap-vcpkg.bat
 里面的代码如下
 ```ps
 powershell.exe -NoProfile -ExecutionPolicy Bypass "& {& '%~dp0scripts\bootstrap.ps1' %*}"
 ```
 意思不知道，下载了一个vcpkg.exe在文件夹里，这就是vcpkg了，把它放在文件夹C:\vcpkg里面，并把文件夹添加到PATH
 
 暂时还没有把vcpkg整合到vs里面
 据说是在管理员权限的cmd中输入vcpkg integrate install即可
 用“vcpkg install name（包名）”默认下载的是x86包，在x64系统上不能运行，要使用“vcpkg install name（包名）:x64-windows”才能下载x64版本
 通过 .\vcpkg.exe help triplets 可以查看支持的安装方式
 使用.\vcpkg.exe list 可以列举已经安装的包
 https://blog.csdn.net/cjmqas/article/details/79282847#4-vcpkg%E5%92%8Cvisual-studio%E7%9A%84%E9%9B%86%E6%88%90
 详细解释了与vs集成，全局集成和工程集成，详细解释了
## 6 安装osgEarth
### 6.1 只安装API
 进入vcpkg的源代码目录，确保vcpkg.exe也在这里。
 执行以下
 ```vcpkg install osgearth:x64-windows```
 但总是报错各种东西找不到，就手动下载，放到download文件夹里面
 经过4个小时，运行库都编译好了。
 但是只有osgEarth的dll，没有各种工具

## 7 编译osgEarth
发现osgearth的github上有几个thirdParty是快捷方式，还要在以下地址下载真正的源代码
### 7.1 下载lerc
要下载2.2.1版本的，高版本的几个函数声明变了
https://github.com/Esri/lerc/releases/tag/v2.2.1
### 7.2 下载imgui
要下载dock这个分支的
https://github.com/ocornut/imgui/tree/docking
### 7.3 下载rapidjson
  https://github.com/Tencent/rapidjson/releases/tag/v1.1.0

在cmake上设置，发现libzip和zlib总是配置不好
把生成的vs2022工程和依赖等放在了D:\source\osgEarth3.3 build文件里，但是解压缩后，要修改cmake的一个配置，把geos的库文件改成geos_c.lib，不是geos.lib
不要用生成的第三方tinyxml，用osgearth源码自带的tinyxml


### 7.4 生成pb
#### 7.4.1 修改src\\osgEarth\\glyphs.proto
添加第二行
```
syntax = "proto2";
```
#### 7.4.2
把src\\osgEarth\\glyphs.proto生成h和cpp文件
```
protoc --cpp_out=D:\source\osgearth-osgearth-3.3\src\osgEarth glyphs.proto --proto_path=D:\source\osgearth-osgearth-3.3\src\osgEarth
```

#### 7.4.3
把src\\osgEarth\\vector_tile.proto生成h和cpp文件
```
protoc --cpp_out=D:\source\osgearth-osgearth-3.3\src\osgEarth glyphs.proto --proto_path=D:\source\osgearth-osgearth-3.3\src\osgEarth
```



## 8 结果
### 8.1 没成功的插件
与tinyglTf和draco有关系的项目debug没成功release版成功了
plugin的gltf 

### 8.2 尝试运行了几个例子

运行test
有几个不能通过，发现是路径不对
ImageLayerTest.cpp里面有两个路径
修改为绝对路径
```ps
 layer->setURL("D:\\source\\osgearth-osgearth-3.3\\data\\world.tif");// ../data/world.tif");
```
和坐标转换的几个例子通不过，不知道proj是不是缺配置文件之类的
把proj源代码的data目录复制到osgEarth_testsd.exe下面运行，还是不行
把gdal源代码的data目录复制到osgEarth_testsd.exe下面运行，还是不行

分别提醒缺少字体Verdana.ttf和CascadiaCode.ttf
在下载了Verdana.ttf
在https://github.com/microsoft/cascadia-code/releases下载了CascadiaCode.ttf

运行Example osgEarth_annotation命令行输出
```psFontconfig error: Cannot load default config file: No such file: (null)```
是字体库的路径不对

### 8.3 关于openSceneGraph库的问题
#### 8.3.1 用vcpkg编译的osg
用vcpkg编译的osg试一下，在公司就是vcpkg编译的osg和自己编译的osgearth可以读出tif地图

把D:\\source\\vcpkg-2022.08.15\\installed\\x64-windows\\debug\\bin里面的dll和pdb
D:\\source\\vcpkg-2022.08.15\\installed\\x64-windows\\bin里面的dll
D:\\source\\vcpkg-2022.08.15\\installed\\x64-windows\\debug\\plugins里面的文件夹
D:\\source\\osgearth-osgearth-3.3-osg-by-vcpkg-build\\lib\\Debug里面的dll
复制到D:\\source\\osgearth-osgearth-3.3-osg-by-vcpkg-build\\bin\\Debug里面

试了一下osgearth果然可以读出world.tif了，但是两个问题
1 osgearth没有tools和example，而且估计vcpkg没有把imgui和lerc和rapidjson整合进去，估计要把正确的osgearth.rar源码替换到download文件夹下面的重新开始编译才可以
2 把自行编译的osgviewerd.exe放到vcpkg的install文件夹下，发现.osg文件能读出，但是.png等图片不能正常绘制，而且.tif文件还是不能正常读
3 imgui的那个osgearth_imguid.exe还是报错
4 gltk的插件还是不对

#### 8.3.2 自行编译openSceneGraph
无论自行编译osg的时候要不要libtiff，编译出来的openSceneGraph是正常的，但是编译出来的OsgEarth能够正常读出.earth文件里的.tiff文件了，但是有些例子报osgd.dll或osg.dll错误

综上来看，还是要用vcpkg编译出来的osg配自己编译的osgEarth，但是要想办法让vcpkg编译出来的osg有application和example，而且要解决gltk和imgui的问题