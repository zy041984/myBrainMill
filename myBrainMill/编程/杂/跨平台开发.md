# 需求
在windows下使用vscode作为IDE，开发Qt程序，交叉编译为linux的二进制
## 工具链
1. 要有qt的linux版本，在清华镜像下载了。
2. 要有编译器和链接器，据说要使用mingw64
[Create C++ cross-platform projects in Visual Studio | Microsoft Learn](https://learn.microsoft.com/en-us/cpp/build/get-started-linux-cmake?view=msvc-170)

# 安装wsl
[安装 WSL | Microsoft Learn](https://learn.microsoft.com/zh-cn/windows/wsl/install)
wsl --install超级慢啊，ctrl+c之后还不能在商店里下载ubuntu了
查询安装的linux版本
`wsl.exe --list --verbose`
关闭wsl
```
wsl --shutdown
```
删除已经安装的系统
```
wsl --unregister Ubuntu-22.04
```
卸载wsl
```
cd C:\Program Files\WSL
wsl --uninstall
```
导出快照
```
wsl --export <Distribution Name> <FileName>
例如
wsl --export Ubuntu-22.04 d:/Ubuntu-22.04-fresh-yykk
```
导入本地分发的tar文件包
```
wsl --import <Distribution Name> <InstallLocation> <FileName>
例如wsl --import Ubuntu-22.04 c:/myUbuntu-22.04 d:/Ubuntu-22.04-fresh-yykk
```
安装nautilus类似于exporler，可以暂时不用，windows上面可以访问linux的文件目录，但是估计最好查看，不要编辑
`sudo apt install nautilus -y`
# 配置vs和wsl的ssh
## 在wsl上生成公钥密钥，留下公钥
生成公密钥`ssh-keygen -t ecdsa  -f ~/.ssh/id_ecdsa`
留下公钥`cat home/yykk/.ssh/id_ecdsa.pub >> home/yykk/.ssh/authorized_keys`
改变属性`sudo chmod 600 id_ecdsa`
## 密钥给windows
密钥复制给windows，可以先mv到d盘，再剪切到windows用户名目录下的`.ssh`文件夹
## 开启ssh服务和设置
检查wsl是否运行ssh的命令`sudo service ssh status`，重启ssh的命令是`sudo service ssh restart`能看到ssh处于active中
查看用户是否具有ssh权限`groups yykk`
给用户添加ssh权限`sudo usermod -aG ssh yykk`
`nano /etc/ssh/sshd_config`可以编辑ssh的配置，方向键移动光标，ctrl+大写O保存，ctrl+X退出
# 基于cmake使用vs2022开发linux
## 安装
在vs2022中选择工作负载，c++ for linux，可以取消github copilot和Iot
- 设置一个linux机器
可以是个虚拟机，WSL。
- vs需要在linux主机上安装这些工具，gdb，ssh，rsync，make，zip
使用这些命令安装
`sudo apt install -y openssh-server build-essential gdb rsync make zip`
- ubuntu-24.04默认安装g++-13，有format头文件
- vs需要linux主机上装有具有server模式的cmake，版本至少3.8
- 使用命令`sudo ./cmake-3.11.18033000-MSVC_2-Linux-x86_64.sh --skip-license --prefix=/usr`把cmake安装在`usr\bin`，vs2022要在这里寻找cmake
怎么把文件传给wsl，WSL 默认会把 Windows 的盘挂载到`/mnt`下，直接访问就行
命令`whereis cmake`输出了`usr\bin`，确认cmake安装结果
怎么查看build-essential安装的结果
`dpkg -L | grep  build-essential`

到这里为止，在vs中读取spdlog1.20的cmake的cmakeList.txt文件，ssh连接wsl服务器，新建一个linux-x64-debug的配置
spdlog库和example已经可以生成。

在example项目上右键单击，点击add debug Configuration，将创建文件launch.vs.json
有一个参数数组“pipeArgs”。 它包含一行：“${debuggerCommand}”。 它是在远程计算机上启动 `gdb` 的命令
# 安装qtForLinux
sudo apt install libxkbcommon-x11-0
sudo apt install libxcb-icccm4
sudo apt install libxcb-image0
sudo apt install libxcb-keysyms1
sudo apt install libxcb-render-util0
sudo apt install libxcb-shape0
sudo apt install libxcb-cursor0
sudo apt install libxcb-cursor-dev
运行qt-opensource-linux-x64-5.11.3.run后，会把qt安装在home文件夹下
下载解压了vscode 这个不行，试试用deb包安装
sudo dpkg -i /mnt/d/code_1.107.1-1765982436_amd64.deb
有依赖问题，用下面修复
sudo apt --fix-broken install
再次安装code
sudo dpkg -i /mnt/d/code_1.107.1-1765982436_amd64.deb
whereis code 在usr/bin/code
安装了ninja
sudo apt install ninja-build
修改`.bashrc`文件，在末尾添加
```
export PATH="/path/to/your/qt/bin:$PATH" 替换为你的 Qt 绝对安装路径 
export QT_DIR="/path/to/your/qt"
export PATH="/path/to/your/vscode/bin:$PATH" 替换为你的vscode绝对安装路径
export PATH="/path/to/your/cmake/bin:$PATH" 替换为你的cmake绝对安装路径
```
source ~/.bashrc
qmake --version
echo $QT_DIR

code中安装了c++和c++theme和cmake tools
命令面板输入cmake quick start，选择从现有的presets继承，现有的presets是qt，新的子presets起名字叫myLinux
感觉不太对，所以恢复windows下的CMakePresets.json，新建一个CMakeUserPresets.json，继承qt，起名字叫myLinux
命令面板输入cmake configure，报错，没有gl头文件
apt-cache search mesa-dev显示当前可以安装的包
sudo apt install libglu1-mesa-dev
现在cmake configure通过

现在安装了vscode的cmake tools扩展，不知道这个步骤是否需要
vscode中添加cmake的路径
1. 打开命令面板 `Ctrl+Shift+P`
2. 输入 `Preferences: Open User Settings (JSON)`
3. 写入配置
```
{ "cmake.cmakePath": "/your/custom/cmake/path/bin/cmake" }
```
# 操作记录
vs安装好工作负载linux
wsl安装全新的ubuntu24.04，设置用户名和密码
导出快照
然后wsl --unregister ubunt24.04删除安装的系统
wsl --import Ubuntu-24.04 c:/myUbuntu-24.04 d:/Ubuntu-24.04-fresh-yykk 恢复全新的ubuntu24.04
su - yykk
sudo apt update
sudo apt install g++ -y
 - 测试有了format头文件
sudo apt install -y openssh-server build-essential gdb rsync make zip
sudo /mnt/d/download/ForDevelop/cmake-3.19.4268486-MSVC_2-Linux-x64.sh --skip-license --prefix=/usr
cd /home/yykk
ssh-keygen -t ecdsa  -f ~/.ssh/id_ecdsa -m pem
- vs要求私钥形式为pem
cat /home/yykk/.ssh/id_ecdsa.pub >> /home/yykk/.ssh/authorized_keys
sudo chmod 600 ~/.ssh/id_ecdsa
sudo cp /home/yykk/.ssh/id_ecdsa /mnt/d/id_ecdsa
把私钥复制到windows的C盘用户目录的.ssh下面
sudo service ssh status
sudo service ssh restart
 - 发现ssh服务已经运行
 - 在window的vs2022上tools-options-crosscompile已经可以建立remote system并用私钥形式连接了


## 更新到支持c++20
更新源，安装g++11
```
sudo add-apt-repository ppa:ubuntu-toolchain-r/test 
sudo apt update
sudo apt install g++-11
```
还没做这一步更新替代链接
```sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-11 110
sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-11 110
```
选择默认版本
```
sudo update-alternatives --config gcc sudo update-alternatives --config g++
```
验证安装
```
g++ --version #应输出g++ 11.x.x 
g++ -std=c++20 -E - < /dev/null #无错误表示支持C++20
```
还是不行啊
看来要试一试安装22.04

/dev/shm下面的文件就是建立的共享内存和POSIX信号量
systemV信号量不是文件，可以用`ipcs -s`看到
## cmakeList的工程
以spdlog为例子
使用vs2022的菜单`file`-`open`-`cmake`打开spdlog的cmakeList.txt
当打开使用cmake的文件夹时候，vs自动生成cmake cache
- 默认创建一个x64-Debug配置。当你增加一个配置的时候，vs自动生成一个文件`CMakeSettings.json`。好像没有自动生成`CMakeSettings.json`
- 在下拉菜单中选择`Manage Configurations`建立一个'Linux-GCC_Debug'配置，在'CMake generator'中选择unix-make，保存
- 在弹出的Connect to Remote System中填入hostName为localhost，用户名和密码就是wsl的用户名和密码。或者用私钥连接。vs会把这些保存在`CMakeSettings.json`作为Linux-GCC-Debug的配置。然后vs会把文件发送到remote主机并生成cmake cache，也会从remote下载头文件到windows

[Cross-compile | Qt VS Tools](https://doc.qt.io/qtvstools/qtvstools-how-to-cross-compile.html)
[在 Visual Studio 中部署、运行和调试 Linux MSBuild C++ 项目 | Microsoft Learn](https://learn.microsoft.com/zh-cn/cpp/linux/deploy-run-and-debug-your-linux-project?view=msvc-170)
[Create C++ cross-platform projects in Visual Studio | Microsoft Learn](https://learn.microsoft.com/en-us/cpp/build/get-started-linux-cmake?view=msvc-170)
[演练：使用适用于 Linux 的 Microsoft Windows 子系统 2 (WSL 2) 和 Visual Studio 2022 生成和调试 C++ | Microsoft Learn](https://learn.microsoft.com/zh-cn/cpp/build/walkthrough-build-debug-wsl2?view=msvc-170)



操作记录
恢复全新的ubuntu24.04
su - yykk
sudo apt update
sudo apt install g++ -y
 - 测试有了format头文件
sudo apt install -y openssh-server build-essential gdb rsync make zip
sudo /mnt/d/download/ForDevelop/cmake-3.19.4268486-MSVC_2-Linux-x64.sh --skip-license --prefix=/usr
cd /home/yykk
ssh-keygen -t ecdsa  -f ~/.ssh/id_ecdsa -m pem
- vs要求私钥形式为pem
cat /home/yykk/.ssh/id_ecdsa.pub >> /home/yykk/.ssh/authorized_keys
sudo chmod 600 ~/.ssh/id_ecdsa
sudo cp /home/yykk/.ssh/id_ecdsa /mnt/d/id_ecdsa
把私钥复制到windows的C盘用户目录的.ssh下面
sudo service ssh status
sudo service ssh restart
 - 发现ssh服务已经运行
 - 在window的vs2022上tools-options-crosscompile已经可以建立remote system并用私钥形式连接了
- 编译spdlog还是没有fmt头文件，看来还是要更新g++
- 到gnu网站下载包看了看，只有g++-13.4和g++-14.3才有头文件format
- 更换了清华的源[ubuntu | 镜像站使用帮助 | 清华大学开源软件镜像站 | Tsinghua Open Source Mirror](https://mirrors.tuna.tsinghua.edu.cn/help/ubuntu/)
- 添加了源，从test源中安装了g++-13
sudo add-apt-repository ppa:ubuntu-toolchain-r/test -y
sudo add-apt-repository ppa:ubuntu-toolchain-r/ppa -y
sudo apt update
apt list -a g++-14
sudo apt install g++-13 -y
sudo apt install libxkbcommon-x11-0
sudo apt install libxcb-icccm4
sudo apt install libxcb-image0
sudo apt install libxcb-keysyms1
sudo apt install libxcb-render-util0
sudo apt install libxcb-shape0
sudo apt install libxcb-cursor0
sudo apt install libxcb-cursor-dev

这些不行啊，vs qt tools在vs上调试qt
sudo mkdir -p /mnt/Qt5.11.3
sudo ln -s /home/yykk/Qt5.11.3 /mnt/Qt5.11.3
sudo ln -s /home /mnt/home
然后在vs中Extension，VS Qt Tools，Qt Versions，增加一个Qt版本。
host选择WSL，可以避免向ssh一样复制文件到remote
地址选择`\\wsl.localhost\Ubuntu-24.04\home\yykk\Qt5.11.3\5.11.3\gcc_64`
安装
sudo apt install libnspr4 libnss3
ldd code查看它的依赖
sudo apt install libasound2t64
然后code打开了一次无法打开
删除了之后才能再次打开
rm -rf ~/.vscode-server
rm -rf ~/.vscode


[Install Qt 5 on Ubuntu - Qt Wiki](https://wiki.qt.io/Install_Qt_5_on_Ubuntu)